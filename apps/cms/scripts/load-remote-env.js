import { existsSync, statSync } from 'fs'
import { copyFile, writeFile } from 'fs/promises'
import { config } from 'dotenv'
import { expand } from 'dotenv-expand'

const loadEnv = async () => {
  const DOTENV_KEY = process.env.DOTENV_KEY // Set this in hosting provider's environment variables
  const envVaultPath = '../../.env.vault'

  if (!DOTENV_KEY) {
    console.error('No DOTENV_KEY found in process.env\n')

    return
  }

  if (!existsSync(envVaultPath)) {
    console.error('No .env.vault found in root directory\n')

    return
  }

  if (!statSync(envVaultPath).size) {
    console.error('.env.vault found in root directory, but it is empty\n')

    return
  }

  try {
    await copyFile(envVaultPath, '.env.vault')

    console.info('Successfully copied .env.vault to local dir\n')
  } catch (error) {
    console.error('Failed to copy .env.vault to local dir', error, '\n')
  }

  const envConfig = expand(config({ DOTENV_KEY })) // If DOTENV_KEY found, get the .env.vault, load it to get shared env variables

  if (!envConfig.parsed || Object.keys(envConfig.parsed).length === 0)
    throw new Error('\n\n\nNo .env.vault found or it is empty\n\n\n')

  try {
    await writeFile(
      '.env',
      '# This file is generated by /apps/cms/scripts/load-remote-env.ts\n' +
        '# DO NOT ATTEMPT TO EDIT THIS FILE\n' +
        Object.entries(envConfig.parsed)
          .map(([key, value]) => `${key.startsWith('PUBLIC_') ? `NEXT_${key}` : key}=${value}`)
          .join('\n'),
    )

    console.log('\n\n\nSuccessfully loaded .env.vault to .env\n\n\n')
  } catch (error) {
    console.error('\n\n\nFailed to load .env.vault to .env', error, '\n\n\n')
  }
}

loadEnv()
